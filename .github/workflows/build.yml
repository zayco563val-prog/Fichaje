name: Build APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-24.04

    steps:
      # 1. Clonar el repositorio
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Instalar dependencias del sistema
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            python3 python3-pip python3-venv \
            openjdk-17-jdk unzip zip \
            build-essential git \
            libffi-dev libssl-dev \
            liblzma-dev zlib1g-dev \
            libncurses5 libncurses5-dev \
            libgdbm-dev libsqlite3-dev \
            curl wget

      # 3. Configurar Python
      - name: Setup Python
        run: |
          python3 -m pip install --upgrade pip setuptools wheel

      # 4. Instalar Buildozer y Cython
      - name: Install Buildozer and Cython
        run: |
          python3 -m pip install --upgrade buildozer cython

      # 5. Instalar dependencias de Python de la app
      - name: Install additional Python requirements
        run: |
          # Primero las básicas
          python3 -m pip install kivy==2.3.0 gspread google-auth plyer
          # Luego jnius
          python3 -m pip install jnius
          # Por último KivyMD
          python3 -m pip install kivymd

      # 6. Verificar que Buildozer vea el archivo .spec
      - name: List project files
        run: ls -la

      # 7. Compilar el APK
      - name: Build APK
        run: |
          buildozer android debug

      # 8. Subir APK como artefacto
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: FichajeApp-debug.apk
          path: bin/*.apk
